# Caddy reverse proxy with Authentik forward auth.
# All services use internal Docker hostnames (authentik:9000, app:8080).
# For TLS in production, use a real hostname and uncomment the first line.

# :80 {
# Replace with your domain for TLS, e.g.:
# api.example.com {
:80 {
	# Authentik outpost and UI: required for login and forward_auth (path preserved)
	handle /outpost.goauthentik.io/* {
		reverse_proxy authentik:9000
	}
	handle /if/* {
		reverse_proxy authentik:9000
	}
	handle /application/* {
		reverse_proxy authentik:9000
	}

	# API: forward auth then proxy to app. Authentik sets X-Authentik-* headers.
	# App validates JWT (Bearer or, if implemented, X-Authentik-Jwt).
	handle /api/* {
		forward_auth authentik:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Name X-Authentik-Uid X-Authentik-Jwt
			trusted_proxies private_ranges
		}
		reverse_proxy app:8080
	}

	# Health/actuator and Swagger: proxy to app (optional; tighten in production)
	handle /actuator/* {
		reverse_proxy app:8080
	}
	handle /v3/api-docs* {
		reverse_proxy app:8080
	}
	handle /swagger-ui* {
		reverse_proxy app:8080
	}

	# Default: serve Authentik (so / goes to login)
	handle {
		reverse_proxy authentik:9000
	}
}
